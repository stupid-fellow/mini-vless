#!/bin/bash

# ==================================================
# 脚本配置与变量
# ==================================================
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
PLAIN='\033[0m'

# 核心文件路径 (用于最后调用显示节点)
RV_SCRIPT="/root/rv.sh"

# ==================================================
# 基础函数
# ==================================================

# 检查是否为 Root 用户
check_root() {
    if [ "$EUID" -ne 0 ]; then
        echo -e "${RED}错误：请使用 root 用户运行此脚本！${PLAIN}"
        exit 1
    fi
}

# ==================================================
# 功能函数
# ==================================================

# 1. 安装 VLESS 主逻辑
install_vless() {
    echo -e "${GREEN}>>> 开始安装 VLESS 服务...${PLAIN}"
    
    # -----------------------------------------------------------
    # 【TODO: 请在此处填入你的安装命令】
    # -----------------------------------------------------------
    # 这里是你原本的安装逻辑，比如：
    # 1. 更新系统: apt update -y
    # 2. 下载内核: wget ...
    # 3. 配置 config.json
    # 4. 配置 Systemd 服务
    
    echo -e "正在执行安装步骤 (模拟中)..."
    sleep 1
    
    # 假设你的安装过程会下载或生成 /root/rv.sh 文件
    # 如果没有，请确保在这里下载它，例如：
    # wget -O /root/rv.sh https://你的域名/rv.sh && chmod +x /root/rv.sh
    
    # -----------------------------------------------------------

    echo -e "${GREEN}>>> VLESS 服务安装完成！${PLAIN}"
    echo -e "${YELLOW}>>> 正在调取节点信息...${PLAIN}"
    echo -e "--------------------------------------------------"

    # 【核心需求】：安装完成后直接执行 rv.sh info
    if [ -f "$RV_SCRIPT" ]; then
        # 赋予执行权限以防万一
        chmod +x "$RV_SCRIPT"
        # 执行显示节点
        bash "$RV_SCRIPT" info
    else
        echo -e "${RED}警告：未找到 $RV_SCRIPT 文件，无法自动显示节点信息。${PLAIN}"
        echo -e "${YELLOW}请检查安装过程中是否正确下载了该管理脚本。${PLAIN}"
    fi
}

# 2. 卸载 VLESS 主逻辑
uninstall_vless() {
    echo -e "${YELLOW}>>> 正在停止并卸载 VLESS 服务...${PLAIN}"
    
    # -----------------------------------------------------------
    # 【TODO: 请在此处填入你的卸载命令】
    # -----------------------------------------------------------
    # 例如：
    # systemctl stop xray
    # systemctl disable xray
    # rm -rf /usr/local/etc/xray
    # rm -f /root/rv.sh  <-- 是否连同管理脚本一起删除？
    
    echo -e "正在清理文件 (模拟中)..."
    sleep 1
    # -----------------------------------------------------------
    
    echo -e "${GREEN}>>> 服务已卸载完成。${PLAIN}"
}

# ==================================================
# 交互菜单
# ==================================================
show_menu() {
    check_root
    clear
    echo -e "=================================="
    echo -e "    ${GREEN}VLESS 自动化部署脚本${PLAIN}"
    echo -e "=================================="
    echo -e "  ${GREEN}1.${PLAIN} 安装 VLESS 服务 ${YELLOW}(安装后自动显示节点)${PLAIN}"
    echo -e "  ${GREEN}2.${PLAIN} 卸载 VLESS 服务"
    echo -e "  ${GREEN}0.${PLAIN} 退出脚本"
    echo -e "=================================="
    read -p " 请输入选择 [0-2]: " num

    case "$num" in
        1)
            install_vless
            ;;
        2)
            uninstall_vless
            ;;
        0)
            exit 0
            ;;
        *)
            echo -e "${RED}请输入正确的数字 [0-2]${PLAIN}"
            sleep 1
            show_menu
            ;;
    esac
}

# 启动脚本
show_menu
